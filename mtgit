#!/bin/bash

# é»˜è®¤å€¼
MAX_DEPTH=99
TARGET_DIR="."
SHOW_HELP=0

# é¢œè‰²å®šä¹‰
COLOR_RESET='\033[0m'
COLOR_YELLOW='\033[1;33m'
COLOR_GREEN='\033[1;32m'
COLOR_RED='\033[1;31m'
COLOR_CYAN='\033[1;36m'
COLOR_BLUE='\033[1;34m'

# å¸®åŠ©ä¿¡æ¯
show_help() {
    cat << EOF
Usage: $(basename $0) [-d depth] [-h] [directory]

äº¤äº’å¼ git ä»“åº“ç®¡ç†å·¥å…·ï¼ˆç±»ä¼¼ tig çš„å¤šä»“åº“ç‰ˆæœ¬ï¼‰

Options:
    -d depth    è®¾ç½®æŸ¥æ‰¾ git ä»“åº“çš„æœ€å¤§æ·±åº¦ (é»˜è®¤: æ— é™é€’å½’)
    -h          æ˜¾ç¤ºæ­¤å¸®åŠ©ä¿¡æ¯

Arguments:
    directory   è¦æœç´¢çš„ç›®å½• (é»˜è®¤: å½“å‰ç›®å½• .)

åŠŸèƒ½è¯´æ˜ï¼š
    1. åˆ—å‡ºæ‰€æœ‰ git ä»“åº“åŠå…¶çŠ¶æ€
    2. é€‰æ‹©ä»“åº“åå¯ä»¥ï¼š
       - æŸ¥çœ‹è¯¦ç»†çŠ¶æ€ (status)
       - æŸ¥çœ‹ diff
       - æŸ¥çœ‹ç»Ÿè®¡ (stat)
       - è¿›å…¥ tig æŸ¥çœ‹å†å²
       - æäº¤æ”¹åŠ¨ (commit)
       - æ¨é€ (push)
       - æ‹‰å– (pull)
       - æ‰“å¼€ä»“åº“ç›®å½•

å¿«æ·é”®ï¼š
    â†‘/â†“ æˆ– j/k    - ä¸Šä¸‹ç§»åŠ¨
    Enter         - é€‰æ‹©ä»“åº“ï¼Œè¿›å…¥æ“ä½œèœå•
    Ctrl+C æˆ– q   - é€€å‡º

Examples:
    $(basename $0)              # æŸ¥æ‰¾å½“å‰ç›®å½•ä¸‹æ‰€æœ‰ä»“åº“
    $(basename $0) components   # æŸ¥æ‰¾ components ç›®å½•
    $(basename $0) -d 2         # é™åˆ¶æ·±åº¦ä¸º 2

ä¾èµ–ï¼š
    - fzf (ç”¨äºäº¤äº’å¼é€‰æ‹©)
    - tig (å¯é€‰ï¼Œç”¨äºæŸ¥çœ‹å†å²)

å®‰è£… fzfï¼š
    sudo apt install fzf        # Debian/Ubuntu
    brew install fzf            # macOS
EOF
}

# è§£æå‚æ•°
while getopts "d:h" opt; do
    case $opt in
        d)
            MAX_DEPTH=$OPTARG
            if ! [[ "$MAX_DEPTH" =~ ^[0-9]+$ ]]; then
                echo "é”™è¯¯: -d å‚æ•°å¿…é¡»æ˜¯æ­£æ•´æ•°" >&2
                show_help
                exit 1
            fi
            ;;
        h)
            show_help
            exit 0
            ;;
        ?)
            show_help
            exit 1
            ;;
    esac
done

# è·å–ä½ç½®å‚æ•°ï¼ˆç›®å½•ï¼‰
shift $((OPTIND - 1))
if [ $# -gt 0 ]; then
    TARGET_DIR="$1"
    if [ ! -d "$TARGET_DIR" ]; then
        echo "é”™è¯¯: ç›®å½• '$TARGET_DIR' ä¸å­˜åœ¨" >&2
        exit 1
    fi
fi

# æ£€æŸ¥ä¾èµ–
if ! command -v fzf &> /dev/null; then
    echo "é”™è¯¯: éœ€è¦å®‰è£… fzf" >&2
    echo "å®‰è£…: sudo apt install fzf (Debian/Ubuntu) æˆ– brew install fzf (macOS)" >&2
    exit 1
fi

# è·å–ä»“åº“çŠ¶æ€ä¿¡æ¯
get_repo_status() {
    local repo_path="$1"
    cd "$repo_path"
    
    local branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null || echo "no-branch")
    local status=""
    local status_symbol=""
    local color=""
    
    # æ£€æŸ¥æ˜¯å¦æœ‰æ”¹åŠ¨
    if [ -n "$(git status --porcelain 2>/dev/null)" ]; then
        # æœ‰æ”¹åŠ¨
        local modified=$(git status --porcelain 2>/dev/null | grep -c "^ M" || echo 0)
        local added=$(git status --porcelain 2>/dev/null | grep -c "^A " || echo 0)
        local deleted=$(git status --porcelain 2>/dev/null | grep -c "^D " || echo 0)
        local untracked=$(git status --porcelain 2>/dev/null | grep -c "^??" || echo 0)
        local staged=$(git diff --cached --numstat 2>/dev/null | wc -l)
        
        status="M:$modified A:$added D:$deleted ?:$untracked S:$staged"
        status_symbol="âœ—"
        color="$COLOR_RED"
    else
        # æ£€æŸ¥æ˜¯å¦éœ€è¦ push/pull
        local ahead=$(git rev-list --count @{u}..HEAD 2>/dev/null || echo 0)
        local behind=$(git rev-list --count HEAD..@{u} 2>/dev/null || echo 0)
        
        if [ "$ahead" -gt 0 ] || [ "$behind" -gt 0 ]; then
            status="â†‘$ahead â†“$behind"
            status_symbol="â‡…"
            color="$COLOR_YELLOW"
        else
            status="clean"
            status_symbol="âœ“"
            color="$COLOR_GREEN"
        fi
    fi
    
    echo -e "${color}${status_symbol}${COLOR_RESET} ${COLOR_CYAN}${repo_path}${COLOR_RESET} ${COLOR_BLUE}[$branch]${COLOR_RESET} $status"
}

# åˆ—å‡ºæ‰€æœ‰ä»“åº“
list_repos() {
    local temp_file=$(mktemp)
    
    find "$TARGET_DIR" -maxdepth $MAX_DEPTH -type d -name .git 2>/dev/null | sort | while read git_dir; do
        local repo_path=$(dirname "$git_dir")
        echo "$repo_path"
    done > "$temp_file"
    
    cat "$temp_file"
    rm -f "$temp_file"
}

# æ˜¾ç¤ºä»“åº“æ“ä½œèœå•
show_repo_menu() {
    local repo_path="$1"
    
    while true; do
        clear
        echo -e "${COLOR_YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${COLOR_RESET}"
        echo -e "${COLOR_CYAN}ä»“åº“: $repo_path${COLOR_RESET}"
        echo -e "${COLOR_YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${COLOR_RESET}"
        echo ""
        
        cd "$repo_path"
        
        # æ˜¾ç¤ºå½“å‰çŠ¶æ€æ‘˜è¦
        local branch=$(git rev-parse --abbrev-ref HEAD 2>/dev/null)
        echo -e "${COLOR_BLUE}åˆ†æ”¯:${COLOR_RESET} $branch"
        echo ""
        
        # ç®€çŸ­çŠ¶æ€
        if [ -n "$(git status --porcelain)" ]; then
            echo -e "${COLOR_RED}æœ‰æœªæäº¤çš„æ”¹åŠ¨${COLOR_RESET}"
            git status --short
        else
            echo -e "${COLOR_GREEN}å·¥ä½œåŒºå¹²å‡€${COLOR_RESET}"
        fi
        
        echo ""
        echo -e "${COLOR_YELLOW}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${COLOR_RESET}"
        
        # ä½¿ç”¨ fzf æ˜¾ç¤ºæ“ä½œèœå•
        local action=$(echo -e "ğŸ“Š æŸ¥çœ‹è¯¦ç»†çŠ¶æ€ (status)\nğŸ“ æŸ¥çœ‹å·®å¼‚ (diff)\nğŸ“ˆ æŸ¥çœ‹ç»Ÿè®¡ (stat)\nğŸ“œ æŸ¥çœ‹å†å² (tig)\nâœ… æäº¤æ”¹åŠ¨ (commit)\nâ¬†ï¸  æ¨é€ (push)\nâ¬‡ï¸  æ‹‰å– (pull)\nğŸ”„ åŒæ­¥ (pull + push)\nğŸ“ æ‰“å¼€ç›®å½• (cd)\nğŸ”™ è¿”å›ä»“åº“åˆ—è¡¨\nâŒ é€€å‡º" | \
            fzf --height=50% --reverse --border --prompt="é€‰æ‹©æ“ä½œ > " --ansi --header="ä½¿ç”¨ â†‘â†“ é€‰æ‹©ï¼ŒEnter ç¡®è®¤ï¼ŒCtrl+C å–æ¶ˆ")
        
        case "$action" in
            *"æŸ¥çœ‹è¯¦ç»†çŠ¶æ€"*)
                clear
                git -c color.status=always status
                echo ""
                read -p "æŒ‰ Enter ç»§ç»­..."
                ;;
            *"æŸ¥çœ‹å·®å¼‚"*)
                clear
                git diff --color=always | less -RFX
                ;;
            *"æŸ¥çœ‹ç»Ÿè®¡"*)
                clear
                git diff --stat --color=always
                echo ""
                read -p "æŒ‰ Enter ç»§ç»­..."
                ;;
            *"æŸ¥çœ‹å†å²"*)
                if command -v tig &> /dev/null; then
                    tig
                else
                    clear
                    git log --oneline --graph --color=always -20 | less -RFX
                fi
                ;;
            *"æäº¤æ”¹åŠ¨"*)
                clear
                git status --short
                echo ""
                read -p "æ˜¯å¦æš‚å­˜æ‰€æœ‰æ”¹åŠ¨? (y/N): " stage_all
                if [[ "$stage_all" =~ ^[Yy]$ ]]; then
                    git add -A
                fi
                
                echo ""
                git status --short
                echo ""
                read -p "æäº¤ä¿¡æ¯: " commit_msg
                if [ -n "$commit_msg" ]; then
                    git commit -m "$commit_msg"
                    echo ""
                    read -p "æŒ‰ Enter ç»§ç»­..."
                fi
                ;;
            *"æ¨é€"*)
                clear
                git push
                echo ""
                read -p "æŒ‰ Enter ç»§ç»­..."
                ;;
            *"æ‹‰å–"*)
                clear
                git pull
                echo ""
                read -p "æŒ‰ Enter ç»§ç»­..."
                ;;
            *"åŒæ­¥"*)
                clear
                git pull && git push
                echo ""
                read -p "æŒ‰ Enter ç»§ç»­..."
                ;;
            *"æ‰“å¼€ç›®å½•"*)
                clear
                echo "åœ¨æ–° shell ä¸­æ‰“å¼€ä»“åº“ç›®å½•: $repo_path"
                echo "ä½¿ç”¨ exit æˆ– Ctrl+D è¿”å› mygit"
                echo ""
                cd "$repo_path" && $SHELL
                ;;
            *"è¿”å›ä»“åº“åˆ—è¡¨"*)
                return 0
                ;;
            *"é€€å‡º"*|"")
                exit 0
                ;;
        esac
    done
}

# ä¸»å¾ªç¯
main() {
    while true; do
        # ç”Ÿæˆä»“åº“åˆ—è¡¨å¹¶æ˜¾ç¤ºçŠ¶æ€
        local temp_list=$(mktemp)
        local temp_map=$(mktemp)
        
        echo "æ­£åœ¨æ‰«æä»“åº“..." >&2
        
        local index=1
        find "$TARGET_DIR" -maxdepth $MAX_DEPTH -type d -name .git 2>/dev/null | sort | while read git_dir; do
            local repo_path=$(dirname "$git_dir")
            local status_line=$(get_repo_status "$repo_path")
            echo "$status_line" >> "$temp_list"
            echo "$index|$repo_path" >> "$temp_map"
            index=$((index + 1))
        done
        
        if [ ! -s "$temp_list" ]; then
            echo "æœªæ‰¾åˆ°ä»»ä½• git ä»“åº“" >&2
            rm -f "$temp_list" "$temp_map"
            exit 1
        fi
        
        # ä½¿ç”¨ fzf é€‰æ‹©ä»“åº“
        local selected=$(cat "$temp_list" | \
            fzf --ansi \
                --height=100% \
                --reverse \
                --border \
                --prompt="é€‰æ‹©ä»“åº“ > " \
                --header="æœç´¢æ·±åº¦: $MAX_DEPTH | ç›®å½•: $TARGET_DIR | â†‘â†“ é€‰æ‹©, Enter ç¡®è®¤, Ctrl+C é€€å‡º" \
                --preview='repo_path=$(echo {} | grep -oP "(?<=\x1b\[1;36m)[^\x1b]+(?=\x1b)" || echo {} | awk "{print \$2}"); cd "$repo_path" 2>/dev/null && git -c color.status=always status' \
                --preview-window=right:60%:wrap)
        
        if [ -z "$selected" ]; then
            rm -f "$temp_list" "$temp_map"
            exit 0
        fi
        
        # æå–ä»“åº“è·¯å¾„ï¼ˆä» ANSI é¢œè‰²ä»£ç ä¸­ï¼‰
        local repo_path=$(echo "$selected" | grep -oP "(?<=\x1b\[1;36m)[^\x1b]+" | head -1)
        
        if [ -z "$repo_path" ]; then
            # å¤‡ç”¨æå–æ–¹æ³•
            repo_path=$(echo "$selected" | awk '{print $2}')
        fi
        
        rm -f "$temp_list" "$temp_map"
        
        if [ -n "$repo_path" ] && [ -d "$repo_path" ]; then
            show_repo_menu "$repo_path"
        fi
    done
}

# è¿è¡Œä¸»ç¨‹åº
main
